# 技術實現審查結果

## TODO: High Priority

[ ] 實現 StreamingChunk schema 和 backpressure
    檔案：sre-assistant/utils/a2a_client.py (Line 45-80)
    檔案：sre-assistant/__init__.py (Line 35-55)
    新增：sre-assistant/a2a/protocol.py (需創建)

[ ] 遷移到官方 MatchingEngineIndexEndpoint API  
    檔案：sre-assistant/memory.py (Line 85-120)
    特別是 _create_vector_backend() 方法需要重寫

[ ] 添加 50 並發會話測試
    檔案：test/test_agent.py (需新增測試方法)
    新增：test/test_concurrent_sessions.py (需創建)
    新增：test/test_contracts.py (需創建)

[ ] 實現工具版本相容性檢查
    檔案：sre-assistant/tools.py (Line 45-75)
    需要在 VersionedToolRegistry 類別中補充 check_compatibility() 方法

## TODO: Medium Priority  
[ ] 加入 5 Whys postmortem 模板
    檔案：sub_agents/postmortem/agent.py (Line 35-60)
    檔案：sub_agents/postmortem/prompts.py (需補充模板)
    檔案：sub_agents/postmortem/tools.py (ReportGeneratorTool)

[ ] 實現 SLO 違規自動回滾
    檔案：sre-assistant/slo_manager.py (Line 180-220)
    檔案：sub_agents/remediation/tools.py (ConfigRollbackTool)

[ ] 優化 ParallelAgent 權重算法
    檔案：sre-assistant/agent.py (Line 115-125)
    特別是 diagnostic_phase 的 weights 設定

## TODO: Low Priority
[ ] 添加 Terraform 模組範例
    新增：deployment/terraform/main.tf
    新增：deployment/terraform/variables.tf
    新增：deployment/terraform/modules/agent_engine/

[ ] 實現 canary 部署策略
    檔案：deployment/deploy.py (需補充 canary 邏輯)
    檔案：deployment/cloudbuild.yaml (需新增 canary steps)

[ ] 優化 Docker 鏡像大小
    檔案：deployment/Dockerfile (需優化)

### ⚠️ 部分改進但仍需加強的領域

#### 1. **A2A Streaming 實現（部分改進）**
```python
# 現有實現
async def _execute_with_streaming(self, context, event_queue, query):
    async for chunk in self.agent.execute_streaming(query):
        # 基本 streaming 處理
```

**問題**：
- 缺少 refactor-2.md 建議的 backpressure handling
- 未實現 idempotency token 機制
- 缺少 chunk schema 定義

**建議改進**：
```python
# 加入完整 streaming 協議
@dataclass
class StreamingChunk:
    chunk_id: str
    timestamp: datetime
    type: Literal["progress", "partial_result", "metrics_update"]
    progress: float
    partial_result: Optional[Dict]
    idempotency_token: str
    
class StreamingHandler:
    def __init__(self):
        self.buffer = deque(maxlen=1000)  # Backpressure
        self.seen_tokens = set()  # 冪等性
        
    async def handle_with_flow_control(self, chunk: StreamingChunk):
        if chunk.idempotency_token in self.seen_tokens:
            return  # 防止重複處理
        # 流量控制邏輯
```

#### 2. **記憶體管理 API 使用（需更新）**
**問題**：仍使用自定義 `generate_embedding` 而非官方 API

**建議改進**：
```python
# 使用官方 MatchingEngineIndexEndpoint API
from google.cloud.aiplatform.matching_engine import MatchingEngineIndexEndpoint

class SREMemorySystem:
    def __init__(self):
        self.index_endpoint = MatchingEngineIndexEndpoint(
            index_endpoint_name="projects/.../indexEndpoints/..."
        )
    
    async def upsert_vectors(self, data):
        # 使用官方 API
        return await self.index_endpoint.upsert_datapoints(
            datapoints=data,
            update_mask=["restricts", "crowding_tag"]
        )
```


#### 3. **測試覆蓋度（refactor-2.md 強調但未實現）**
**缺失**：
- 缺少 contract tests 驗證工具呼叫
- 無並發測試（建議的 50 concurrent runs）
- 缺少 hypothesis 屬性測試

**必要補充**：
```python
# test/test_contracts.py
import hypothesis.strategies as st
from hypothesis import given

class TestContracts:
    @given(st.builds(SRERequest))
    def test_request_contract(self, request):
        # 屬性測試確保契約完整性
        assert request.incident_id
        
    def test_concurrent_sessions(self):
        # 50 並發會話測試
        async def run_session(id):
            return await coordinator.execute(...)
        
        results = await asyncio.gather(*[
            run_session(i) for i in range(50)
        ])
```

#### 4. **工具版本管理（refactor-2.md 建議未實現）**
**缺失**：缺少工具版本相容性矩陣

**必要補充**：
```python
class VersionedToolRegistry(ToolRegistry):
    def __init__(self):
        self.compatibility_matrix = {
            "PromQLQueryTool": {
                "2.1.0": ["prometheus>=2.40"],
                "2.0.0": ["prometheus>=2.35"]
            }
        }
    
    def check_compatibility(self, tool_name: str, version: str):
        # 驗證工具版本相容性
        pass
```

## 完善建議優先級

### P0 - 立即修復（影響生產穩定性）
1. **補充並發測試**：添加 50+ 並發會話測試，確保生產負載下穩定性
2. **實現完整 streaming 協議**：加入 backpressure 和 idempotency 機制
3. **強化錯誤恢復**：為所有長時間運行操作添加 circuit breaker

### P1 - 短期改進（1-2 週）
1. **升級記憶體 API**：遷移到官方 MatchingEngineIndexEndpoint
2. **完善工具版本管理**：實現 compatibility_matrix 和自動降級
3. **增強 A2A 認證**：實現完整 token refresh 和 mTLS

### P2 - 中期優化（1 個月）
1. **擴展評估框架**：加入 trajectory evaluation 和業務指標
2. **優化緩存策略**：實現分層緩存（L1/L2/L3）
3. **加強可觀測性**：整合 OpenTelemetry 分散式追蹤



## 2. 非官方 API 實現詳細清單

### 🔴 **記憶體管理 - 最嚴重的非官方實現**


**官方 Vertex AI 實現**：
```python
# 正確的官方實現
from google.cloud.aiplatform.matching_engine import (
    MatchingEngineIndexEndpoint,
    MatchingEngineIndex
)

class SREMemorySystem:
    def __init__(self):
        # 使用官方 API
        self.index_endpoint = MatchingEngineIndexEndpoint(
            index_endpoint_name="projects/{}/locations/{}/indexEndpoints/{}"
        )
        
    async def upsert_vectors(self, embeddings, metadata):
        # 官方 upsert_datapoints 方法
        response = self.index_endpoint.upsert_datapoints(
            datapoints=[
                {
                    "datapoint_id": id,
                    "feature_vector": embedding,
                    "restricts": [{"namespace": "sre_knowledge"}]
                }
            ]
        )
        
    async def search_similar(self, query_embedding):
        # 官方 find_neighbors 方法
        response = self.index_endpoint.find_neighbors(
            deployed_index_id="sre_knowledge",
            queries=[query_embedding],
            num_neighbors=10
        )
```

### 🟡 **嵌入生成 - 使用自定義而非官方 API**

**位置**：`sre-assistant/memory.py`

**問題**：文檔中提到但未顯示實際程式碼的 `generate_embedding` 方法

**應該使用的官方 API**：
```python
from vertexai.language_models import TextEmbeddingModel

class SREMemorySystem:
    def __init__(self):
        # 官方嵌入模型
        self.embedding_model = TextEmbeddingModel.from_pretrained(
            "textembedding-gecko@003"
        )
    
    def generate_embeddings(self, texts: List[str]):
        # 使用官方 API 生成嵌入
        embeddings = self.embedding_model.get_embeddings(texts)
        return [emb.values for emb in embeddings]
```

### 🟡 **A2A 認證 - 不完整的官方實現**

**位置**：`sre-assistant/utils/a2a_client.py`

**問題程式碼**（Line 25-35）：
```python
# 簡化的認證配置
auth_config={
    "type": "oauth2",
    "client_id": "sre-assistant-client",
    "client_secret": os.getenv("A2A_CLIENT_SECRET"),
    "auto_refresh": True,  # 只是標記，未實現
}
```

**缺少的官方實現**：
```python
# 應該使用官方 Google Auth 庫
from google.auth import jwt
from google.auth.transport.requests import Request

class A2AAuthManager:
    def __init__(self):
        self.credentials = jwt.Credentials.from_service_account_file(
            "service-account.json",
            scopes=["https://www.googleapis.com/auth/cloud-platform"]
        )
    
    def refresh_token(self):
        # 官方 token 刷新機制
        if self.credentials.expired:
            self.credentials.refresh(Request())
        return self.credentials.token
```

### 🟡 **部署 API - 簡化版而非完整官方 API**

**位置**：`deployment/deploy.py` (僅在架構中提及)

**問題**：使用簡化的部署方法

**應該使用的官方 API**：
```python
from google.cloud import aiplatform
from google.cloud.aiplatform.preview import agents

# 官方 Agent Engine 部署 API
def deploy_to_agent_engine():
    aiplatform.init(project="your-project", location="us-central1")
    
    # 官方 Agent 部署
    agent = agents.Agent.create(
        display_name="sre-assistant",
        model="gemini-2.0-flash",
        tools=[...],
        system_instruction=GLOBAL_SRE_PROMPT
    )
    
    # 官方端點創建
    endpoint = agent.deploy(
        machine_type="n1-standard-4",
        min_replica_count=2,
        max_replica_count=10,
        accelerator_type=None,
        service_account="sre-assistant@project.iam.gserviceaccount.com"
    )
```

### 🟢 **Callbacks - 正確但可優化**

**位置**：`sre-assistant/agent.py` (Line 75-95)

雖然使用了 `SafetyCallback` 和 `AuditCallback`，但某些方法是自定義的：
```python
# 自定義方法（非標準）
SafetyCallback(
    risk_assessor=self._assess_risk,  # 自定義
    pii_scrubber=self._scrub_pii,     # 自定義
)
```

這些自定義是可接受的擴展，但應確保繼承官方基類。

## 總結

最嚴重的非官方 API 使用是：
1. **Vertex AI Vector Search (MatchingEngineIndexEndpoint)** - 記憶體管理完全使用自定義實現
2. **TextEmbeddingModel** - 嵌入生成未使用官方 API
3. **A2A 認證** - Token 刷新機制不完整
4. **Agent Engine 部署** - 使用簡化版而非完整官方 API

建議優先修復記憶體管理和嵌入生成的 API 使用，因為這些是核心功能且影響系統性能和相容性。


